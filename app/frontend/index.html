<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AutoJudge Dashboard</title>
  <style>
    :root{
      --bg:#ffffff; --fg:#0f172a; --muted:#6b7280; --card:#fff; --line:#e5e7eb;
      --chip:#111827; --chip-fg:#fff; --bad:#991B1B; --badbg:#FEF2F2; --badline:#FCA5A5;
    }
    *{box-sizing:border-box}
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Arial, sans-serif; margin: 28px; color:var(--fg); background:var(--bg); }
    h1 { margin-bottom: 10px; }
    .row { display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; align-items: center; margin-bottom: 10px; }
    input[type=text] { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; }
    button { padding: 10px 16px; border: 0; border-radius: 8px; background: var(--chip); color: var(--chip-fg); cursor: pointer; }
    button[disabled]{opacity:.6; cursor: not-allowed;}
    .muted { color: var(--muted); font-size: 12px; margin-bottom: 8px;}
    .card { border: 1px solid var(--line); padding: 16px; margin-top: 16px; border-radius: 12px; background: var(--card); }
    .score { font-size: 22px; font-weight: 700; }
    .grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 10px; }
    .chip { display: inline-block; background:var(--chip); color:var(--chip-fg); padding: 6px 10px; border-radius: 999px; font-size: 12px;}
    .error { background: var(--badbg); border: 1px solid var(--badline); color: var(--bad); padding: 12px; border-radius: 8px; white-space: pre-wrap;}
    details{margin-top:6px;}
    details > summary{cursor:pointer; font-weight:600;}
    ul{margin:8px 0 0 18px; padding:0}
    code { background:#f3f4f6; padding:2px 6px; border-radius:6px; }
    .kvs{display:grid; grid-template-columns: 140px 1fr; gap:6px; margin-top:8px;}
    .kv-k{color:var(--muted)}
  </style>
</head>
<body>
  <h1>Hackathon Judge</h1>

  <div class="row">
    <input id="repo" type="text" placeholder="GitHub repo (owner/repo or URL) e.g. ajithapamula/Edu-App" />
    <input id="pitch" type="text" placeholder="Pitch URL (optional, README used if empty)" />
    <button id="go">Score</button>
  </div>

  <div class="muted">
    Tip: If you see 0s, check <a href="/debug/diag" target="_blank">/debug/diag</a> for token/rate limits.
  </div>

  <div id="out"></div>

  <script>
    const el = (id) => document.getElementById(id);
    const out = el("out");
    const btn = el("go");

    // Normalize "owner/repo" or any GitHub URL -> full https repo URL
    function normalizeRepo(input) {
      const s = (input || "").trim();
      if (!s) return s;
      if (s.startsWith("http://") || s.startsWith("https://")) return s;
      if (/^[\w.-]+\/[\w.-]+$/.test(s)) return `https://github.com/${s}`;
      return s; // fallback (let backend reject if invalid)
    }

    // Render feedback whether it's a list OR a structured object
    function renderFeedback(feedback) {
      if (!feedback) return "<div class='muted'>No feedback.</div>";

      // List<string>
      if (Array.isArray(feedback)) {
        return `<ul>${feedback.map(x => `<li>${escapeHtml(String(x))}</li>`).join("")}</ul>`;
      }

      // Object of sections: { code_improvements: [...], ... }
      if (typeof feedback === "object") {
        const entries = Object.entries(feedback);
        if (!entries.length) return "<div class='muted'>No feedback.</div>";
        return entries.map(([section, items]) => {
          const title = section.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());
          const list = Array.isArray(items) ? items : [];
          return `
            <details open>
              <summary>${escapeHtml(title)}</summary>
              <ul>${list.map(x => `<li>${escapeHtml(String(x))}</li>`).join("")}</ul>
            </details>
          `;
        }).join("");
      }

      return "<div class='muted'>No feedback.</div>";
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }

    function kvGrid(obj) {
      if (!obj || typeof obj !== "object") return "";
      return `
        <div class="kvs">
          ${Object.entries(obj).map(([k,v]) =>
            `<div class="kv-k">${escapeHtml(k)}</div><div>${escapeHtml(String(v))}</div>`
          ).join("")}
        </div>
      `;
    }

    async function score() {
      out.innerHTML = "";
      const repo = normalizeRepo(el("repo").value);
      const pitch = (el("pitch").value || "").trim() || null;

      if (!repo) {
        out.innerHTML = `<div class="error">Please enter a repository (owner/repo or URL).</div>`;
        return;
      }

      const body = { repo_url: repo, pitch_url: pitch };

      btn.disabled = true;
      btn.textContent = "Scoringâ€¦";
      try {
        const r = await fetch("/score_summary", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        // Gracefully handle non-JSON bodies
        let json;
        try { json = await r.json(); } catch {
          const txt = await r.text();
          throw new Error(`Non-JSON response (HTTP ${r.status}):\n${txt}`);
        }

        if (!r.ok) {
          out.innerHTML = `<div class="error"><b>HTTP ${r.status}</b>\n${escapeHtml(JSON.stringify(json, null, 2))}</div>`;
          return;
        }

        const agents = json.agents || {};
        out.innerHTML = `
          <div class="card">
            <div class="score">Final Score: ${json.final_score ?? "NA"}</div>
            <div>Verdict: <span class="chip">${json.verdict ?? "NA"}</span></div>

            <div style="margin-top:12px">
              <b>Repository</b>: <code>${escapeHtml(json.repo || repo)}</code>
            </div>

            <div class="grid" style="margin-top:12px;">
              <div class="card"><b>Code</b><br>${agents.code ?? "NA"}</div>
              <div class="card"><b>Design</b><br>${agents.design ?? "NA"}</div>
              <div class="card"><b>Pitch</b><br>${agents.pitch ?? "NA"}</div>
            </div>

            <h3 style="margin-top:14px;">Feedback</h3>
            ${renderFeedback(json.feedback)}

            ${json.parts ? `
              <details style="margin-top:12px;">
                <summary>How the final was computed</summary>
                ${kvGrid({ ...json.parts.reduce((acc,p)=>{acc[`${p.agent} (w ${p.weight}%)`]=p.score; return acc;}, {}), "Final Score": json.final_score })}
              </details>
            ` : "" }
          </div>
        `;
      } catch (e) {
        out.innerHTML = `<div class="error">${escapeHtml(String(e))}</div>`;
      } finally {
        btn.disabled = false;
        btn.textContent = "Score";
      }
    }

    el("go").onclick = score;
    // Enter key convenience
    el("repo").addEventListener("keydown", (e)=> e.key==="Enter" && score());
    el("pitch").addEventListener("keydown", (e)=> e.key==="Enter" && score());
  </script>
</body>
</html>
